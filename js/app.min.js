function productCtrl(e,r,t){r.getProducts().then(function(r){e.products=r}),e.$watch(t.getUser,function(r){e.user=r})}function Products(e,r,t){return{getProducts:function(){var o={method:"GET",url:"https://smktesting.herokuapp.com/api/products/"};return e(o).then(function(e){var o=e.data;for(var n in o){var u=o[n].id,s="product_"+u;t.add(s),r.getReviews(u).then(function(e,n){return function(u){o[e].reviews=u,o[e].reviewsNumber=u.length,o[e].averageRate=r.getAverageRate(o[e]),t.remove(n)}}(n,s))}return o})}}}function postReviewCtrl(e,r){e.postReview=function(t){var o=e.product.id,n=e.product.rate,u=e.product.review;r.postReview(o,n,u).then(function(r){r&&($.fancybox.open({src:"#postSuccess"},{touch:!1,keyboard:!1,focus:!1}),t&&(t.$setPristine(),t.$setUntouched()),e.product=void 0)})}}function Reviews(e){return{getReviews:function(r){var t={method:"GET",url:"https://smktesting.herokuapp.com/api/reviews/"+r};return e(t).then(function(e){var r,t,o=e.data;for(var n in o){r="",t=o[n].created_at.split("T").splice(0,1)[0].split("-");for(var u=t.length-1;u>=0;u--)r+=t[u]+".";o[n].created_at=r.slice(0,-1)}return o.reverse()})},getAverageRate:function(e){var r=e.reviews,t=0,o=0;for(var n in r){var u=r[n].rate;u>0&&(o+=u,t++)}var s,a=o/t;return s=a%1==0?0:1,a=(Math.round(2*a)/2).toFixed(s)},postReview:function(r,t,o){var n={method:"POST",url:"https://smktesting.herokuapp.com/api/reviews/"+r,data:{rate:t,text:o}};return e(n).then(function(e){return e.data.success})}}}function StateManager(e){var r=[];return{add:function(t){r.push(t),e.loaded=!1},remove:function(t){var o=r.indexOf(t);r.splice(o,1),0===r.length&&(e.loaded=!0)}}}function authCtrl(e,r){e.$watch(r.getUser,function(r){e.user=r}),e.logout=function(){r.logout()}}function loginCtrl(e,r,t){e.login=function(o){var n=e.user.username,u=e.user.password;n&&u&&r.login(n,u).then(function(r){r.success?$.fancybox.close():e.errorMessage=r.message,e.user=t.reset(o)})},e.onInput=function(){e.errorMessage=!1}}function registerCtrl(e,r,t){e.register=function(o){var n=e.user.username,u=e.user.password;n&&u&&r.register(n,u).then(function(r){r.success?($.fancybox.close(),$.fancybox.open({src:"#regSuccess"},{touch:!1,keyboard:!1,focus:!1})):e.errorMessage=r.message,e.user=t.reset(o)})},e.onInput=function(){e.errorMessage=!1}}function User(e,r){var t;return(t=r.getObject("user"))&&(e.defaults.headers.common.Authorization="Token "+t.token),{getUser:function(){return t},register:function(r,t){var o={method:"POST",url:"https://smktesting.herokuapp.com/api/register/",data:{username:r,password:t}};return e(o).then(function(e){return e.data})},login:function(o,n){var u={method:"POST",url:"https://smktesting.herokuapp.com/api/login/",data:{username:o,password:n}};return e(u).then(function(n){if(n.data.success){t={username:o,token:n.data.token},e.defaults.headers.common.Authorization="Token "+t.token;var u=new Date;u.setDate(u.getDate()+1),r.putObject("user",t,{expires:u})}return n.data})},logout:function(){r.remove("user"),e.defaults.headers.common.Authorization=void 0,t=void 0}}}function userService(){return{reset:function(e){return void(e&&(e.$setPristine(),e.$setUntouched()))}}}angular.module("product",[]),productCtrl.$inject=["$scope","Products","User"],angular.module("product").controller("productCtrl",productCtrl),Products.$inject=["$http","Reviews","StateManager"],angular.module("product").factory("Products",Products),angular.module("review",[]),postReviewCtrl.$inject=["$scope","Reviews"],angular.module("review").controller("postReviewCtrl",postReviewCtrl),Reviews.$inject=["$http"],angular.module("review").service("Reviews",Reviews),angular.module("shared",[]),StateManager.$inject=["$rootScope"],angular.module("shared").factory("StateManager",StateManager),angular.module("user",["ngCookies"]),authCtrl.$inject=["$scope","User"],angular.module("user").controller("authCtrl",authCtrl),loginCtrl.$inject=["$scope","User","userService"],angular.module("user").controller("loginCtrl",loginCtrl),registerCtrl.$inject=["$scope","User","userService"],angular.module("user").controller("registerCtrl",registerCtrl),User.$inject=["$http","$cookies"],angular.module("user").factory("User",User),angular.module("user").factory("userService",userService),angular.module("root",["user","product","review","shared"]),$(function(){$("body").on("click",".fancybox",function(){var e=$(this);$.fancybox.close(),$.fancybox.open({src:e.data("src")},{touch:!1,keyboard:!1,focus:!1})})});